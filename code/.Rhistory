theme_bw() +
theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
legend.title=element_blank(),
axis.ticks.x = element_blank(),axis.text.x = element_blank(),
legend.position = "right")
p_map
test <- soc %>% filter(is.na(year))
View(test)
# load csv
soc <- read.csv("/Users/jiaruofei/MIT Dropbox/Ruofei Jia/Exploration_analysis/soil-organic-carbon-stock-0-30-cm-grams-per-square-meter.csv") %>%
filter(!is.na(year)) # keep only data with sample year
p_map <-
ggplot(countries_sf) +
geom_sf(fill = "lightgray", col="gray", alpha=0.5) +
geom_point(data=soc, aes(x=longitude, y=latitude, color = year), alpha=1, size=0.5) +
xlim(c(-110,-30)) + ylim(c(-60,20)) +
theme_bw() +
theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
legend.title=element_blank(),
axis.ticks.x = element_blank(),axis.text.x = element_blank(),
legend.position = "right")
p_map
# visualize trend
p_time <- ggplot(soc) +
geom_point(aes(x=year, y=soc_stock_g_m2)) +
geom_smooth(aes(x=year, y=soc_stock_g_m2),
method = "lm", se = TRUE)
p_time
# visualize trend
p_time <- ggplot(soc) +
geom_point(aes(x=year, y=log(soc_stock_g_m2))) +
geom_smooth(aes(x=year, y=log(soc_stock_g_m2)),
method = "lm", se = TRUE)
p_time
lm <- lm(log(soc_stock_g_m2) ~ year, data=soc)
summary(lm)
# visualize trend
p_time <- ggplot(soc) +
geom_point(aes(x=year, y=log(soc_stock_g_m2), color=year)) +
geom_smooth(aes(x=year, y=log(soc_stock_g_m2)),
method = "lm", se = TRUE)
p_time
# visualize trend
p_time <- ggplot(soc) +
geom_point(aes(x=year, y=log(soc_stock_g_m2)), size=0.2, alpha=0.3) +
geom_smooth(aes(x=year, y=log(soc_stock_g_m2)),
method = "lm", se = TRUE)
p_time
csv
# load csv
soc_full <- read.csv("/Users/jiaruofei/MIT Dropbox/Ruofei Jia/Exploration_analysis/soil-organic-carbon-stock-0-30-cm-grams-per-square-meter.csv")
soc <- soc_full %>%
filter(!is.na(year)) # keep only data with sample year
p_map <-
ggplot(countries_sf) +
geom_sf(fill = "lightgray", col="gray", alpha=0.5) +
geom_point(data=soc_full, aes(x=longitude, y=latitude, color = year), alpha=1, size=0.5) +
xlim(c(-110,-30)) + ylim(c(-60,20)) +
theme_bw() +
theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
legend.title=element_blank(),
axis.ticks.x = element_blank(),axis.text.x = element_blank(),
legend.position = "right")
p_map
p_map <-
ggplot(countries_sf) +
geom_sf(fill = "lightgray", col="gray", alpha=0.5) +
geom_point(data=soc, aes(x=longitude, y=latitude, color = year), alpha=1, size=0.5) +
xlim(c(-110,-30)) + ylim(c(-60,20)) +
theme_bw() +
theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
legend.title=element_blank(),
axis.ticks.x = element_blank(),axis.text.x = element_blank(),
legend.position = "right")
p_map
# visualize trend
p_time <- ggplot(soc) +
geom_point(aes(x=year, y=log(soc_stock_g_m2)), size=0.2, alpha=0.3) +
geom_smooth(aes(x=year, y=log(soc_stock_g_m2)),
method = "lm", se = TRUE)
p_time
summary(lm)
# load the area data for each model and generate fraction of land cover through zonal statistics
# the
rm(list = ls(all = TRUE))
library(ncdf4)
library(terra)
library(raster)
library(dplyr)
setwd("/Users/jiaruofei/Documents/SOC_change_TRENDYv12/code")
# load processed area grids for each model
all_files <- list.files("../data/processed_area", pattern = "_area\\.nc$", full.names = TRUE)
raster_list <- list()
for (dir in all_files) {
# extract model name
model <- sub(".*/([^/_]+)_area\\.nc$", "\\1", dir)
print(model)
# exclude CLM5.0 and CABLEPOP (not included in comparison)
if (model=="CLM5.0" | model=="CABLEPOP") {
next
}
# load raster
r <- raster(dir)
# reassign value of raster to be 1
r[] <- 1
# rename raster
assign(paste0(model, "_area"), r)
# append to named list
raster_list[[model]] <- r
}
# make list of unique resolutions
unique_rasters <- unique(raster_list)
names(unique_rasters) <- c(1,2,3,4,5,6,7,8,9)
# group models by the same resolution
group_list <- list()
# for each model
for (i in 1:length(raster_list) ) {
print(paste0("i ", i))
# extract model name and resolution raster
model <- names(raster_list)[i]
model_raster <- raster_list[[i]]
# compare model raster with each unique raster
for (j in 1:length(unique_rasters) ) {
print(paste0("j ", j))
# extract j-th unique resolution
unique_raster <- unique_rasters[[j]]
# when find the matching unique resolution, assign group index and continue to next model
if ( identical(model_raster, unique_raster) ) {
# assign group to model in group list
group_list[[model]] <- j
print(paste0("appended ", model, " to unique index ", j))
next
}
}
}
# loop each unique grids
for (j in 1:length(unique_rasters)) {
# extract raster
unique_raster <- unique_rasters[[j]]
# convert to rast
unique_rast <- rast(unique_raster)
# convert to polygon
tic()
rast_polygon <- terra::as.polygons(unique_rast, dissolve=F)
toc()
# rename
#polygon_name <- paste0("polygon",j)
save_dir <- paste0("../data/area_polygons/polygon", j, ".shp")
#assign(paste0("polygon",j), rast_polygon)
# save
writeVector(rast_polygon, save_dir, filetype = "ESRI Shapefile",overwrite=TRUE)
}
library(tictoc)
# loop each unique grids
for (j in 1:length(unique_rasters)) {
# extract raster
unique_raster <- unique_rasters[[j]]
# convert to rast
unique_rast <- rast(unique_raster)
# convert to polygon
tic()
rast_polygon <- terra::as.polygons(unique_rast, dissolve=F)
toc()
# rename
#polygon_name <- paste0("polygon",j)
save_dir <- paste0("../data/area_polygons/polygon", j, ".shp")
#assign(paste0("polygon",j), rast_polygon)
# save
writeVector(rast_polygon, save_dir, filetype = "ESRI Shapefile",overwrite=TRUE)
}
"../data/area_polygons/polygon", j, "/polygon", j, ".shp"
paste0("../data/area_polygons/polygon", j, "/polygon", j, ".shp")
# load the area data for each model and generate fraction of land cover through zonal statistics
# the
rm(list = ls(all = TRUE))
library(ncdf4)
library(terra)
library(raster)
library(dplyr)
library(tictoc)
setwd("/Users/jiaruofei/Documents/SOC_change_TRENDYv12/code")
# load processed area grids for each model
all_files <- list.files("../data/processed_area", pattern = "_area\\.nc$", full.names = TRUE)
raster_list <- list()
for (dir in all_files) {
# extract model name
model <- sub(".*/([^/_]+)_area\\.nc$", "\\1", dir)
print(model)
# exclude CLM5.0 and CABLEPOP (not included in comparison)
if (model=="CLM5.0" | model=="CABLEPOP") {
next
}
# load raster
r <- raster(dir)
# reassign value of raster to be 1
r[] <- 1
# rename raster
assign(paste0(model, "_area"), r)
# append to named list
raster_list[[model]] <- r
}
# make list of unique resolutions
unique_rasters <- unique(raster_list)
names(unique_rasters) <- c(1,2,3,4,5,6,7,8,9)
# group models by the same resolution
group_list <- list()
# for each model
for (i in 1:length(raster_list) ) {
print(paste0("i ", i))
# extract model name and resolution raster
model <- names(raster_list)[i]
model_raster <- raster_list[[i]]
# compare model raster with each unique raster
for (j in 1:length(unique_rasters) ) {
print(paste0("j ", j))
# extract j-th unique resolution
unique_raster <- unique_rasters[[j]]
# when find the matching unique resolution, assign group index and continue to next model
if ( identical(model_raster, unique_raster) ) {
# assign group to model in group list
group_list[[model]] <- j
print(paste0("appended ", model, " to unique index ", j))
next
}
}
}
# loop each unique grids
for (j in 1:length(unique_rasters)) {
# extract raster
unique_raster <- unique_rasters[[j]]
# convert to rast
unique_rast <- rast(unique_raster)
# convert to polygon
tic()
rast_polygon <- terra::as.polygons(unique_rast, dissolve=F)
toc()
# rename
#polygon_name <- paste0("polygon",j)
save_dir <- paste0("../data/area_polygons/polygon", j, "/polygon", j, ".shp")
#assign(paste0("polygon",j), rast_polygon)
# save
writeVector(rast_polygon, save_dir, filetype = "ESRI Shapefile",overwrite=TRUE)
}
# load the area data for each model and generate fraction of land cover through zonal statistics
# the
rm(list = ls(all = TRUE))
library(ncdf4)
library(terra)
library(raster)
library(dplyr)
library(tictoc)
setwd("/Users/jiaruofei/Documents/SOC_change_TRENDYv12/code")
# load processed area grids for each model
all_files <- list.files("../data/processed_area", pattern = "_area\\.nc$", full.names = TRUE)
raster_list <- list()
for (dir in all_files) {
# extract model name
model <- sub(".*/([^/_]+)_area\\.nc$", "\\1", dir)
print(model)
# exclude CLM5.0 and CABLEPOP (not included in comparison)
if (model=="CLM5.0" | model=="CABLEPOP") {
next
}
# load raster
r <- raster(dir)
# reassign value of raster to be 1
r[] <- 1
# rename raster
assign(paste0(model, "_area"), r)
# append to named list
raster_list[[model]] <- r
}
# make list of unique resolutions
unique_rasters <- unique(raster_list)
names(unique_rasters) <- c(1,2,3,4,5,6,7,8,9)
# group models by the same resolution
group_list <- list()
# for each model
for (i in 1:length(raster_list) ) {
print(paste0("i ", i))
# extract model name and resolution raster
model <- names(raster_list)[i]
model_raster <- raster_list[[i]]
# compare model raster with each unique raster
for (j in 1:length(unique_rasters) ) {
print(paste0("j ", j))
# extract j-th unique resolution
unique_raster <- unique_rasters[[j]]
# when find the matching unique resolution, assign group index and continue to next model
if ( identical(model_raster, unique_raster) ) {
# assign group to model in group list
group_list[[model]] <- j
print(paste0("appended ", model, " to unique index ", j))
next
}
}
}
# loop each unique grids
for (j in 1:length(unique_rasters)) {
# extract raster
unique_raster <- unique_rasters[[j]]
# convert to rast
unique_rast <- rast(unique_raster)
# convert to polygon
tic()
rast_polygon <- terra::as.polygons(unique_rast, dissolve=F)
toc()
# rename
#polygon_name <- paste0("polygon",j)
save_dir <- paste0("../data/area_polygons/polygon", j, "/polygon", j, ".shp")
#assign(paste0("polygon",j), rast_polygon)
# save
writeVector(rast_polygon, save_dir, filetype = "ESRI Shapefile",overwrite=TRUE)
}
# this function converts a raster to df with columns x, y, value
raster2df <- function(layer) {
# convert raster to spatial pixel data frame, then to regular dataframe
layer_spdf <- as(layer, "SpatialPixelsDataFrame")
layer_df <- as.data.frame(layer_spdf)
colnames(layer_df) <- c("value", "x", "y")
return(layer_df)
}
save_dir
View(group_list)
group_list
# save group_list
save(group_list, file="../data/area_polygons/unique_polygons_list.rda")
group_list_original <- group_list
# for each model
for (i in 1:length(raster_list) ) {
print(paste0("i ", i))
# extract model name and resolution raster
model <- names(raster_list)[i]
model_raster <- raster_list[[i]]
# compare model raster with each unique raster
for (j in 1:length(unique_rasters) ) {
print(paste0("j ", j))
# extract j-th unique resolution
unique_raster <- unique_rasters[[j]]
# when find the matching unique resolution, assign group index and continue to next model
if ( identical(model_raster, unique_raster) ) {
# assign group to model in group list
group_list <- rbind(
group_list,
data.frame(model=model, polygon_index=j, stringsAsFactors = FALSE)
)
print(paste0("appended ", model, " to unique index ", j))
next
}
}
}
# group models by the same resolution
group_list <- data.frame(model=NA, polygon_index=NA)
# group models by the same resolution
group_list <- data.frame(model=NA, polygon_index=NA)
# for each model
for (i in 1:length(raster_list) ) {
print(paste0("i ", i))
# extract model name and resolution raster
model <- names(raster_list)[i]
model_raster <- raster_list[[i]]
# compare model raster with each unique raster
for (j in 1:length(unique_rasters) ) {
print(paste0("j ", j))
# extract j-th unique resolution
unique_raster <- unique_rasters[[j]]
# when find the matching unique resolution, assign group index and continue to next model
if ( identical(model_raster, unique_raster) ) {
# assign group to model in group list
# group_list <- rbind(
#   group_list,
#   data.frame(model=model, polygon_index=j, stringsAsFactors = FALSE)
#   )
group_list[[model]] <- j
print(paste0("appended ", model, " to unique index ", j))
next
}
}
}
group_list_original <- group_list
# group models by the same resolution
group_list <- data.frame(model=NA, polygon_index=NA)
# for each model
for (i in 1:length(raster_list) ) {
print(paste0("i ", i))
# extract model name and resolution raster
model <- names(raster_list)[i]
model_raster <- raster_list[[i]]
# compare model raster with each unique raster
for (j in 1:length(unique_rasters) ) {
print(paste0("j ", j))
# extract j-th unique resolution
unique_raster <- unique_rasters[[j]]
# when find the matching unique resolution, assign group index and continue to next model
if ( identical(model_raster, unique_raster) ) {
# assign group to model in group list
# group_list <- rbind(
#   group_list,
#   data.frame(model=model, polygon_index=j, stringsAsFactors = FALSE)
#   )
group_list[[model]] <- j
print(paste0("appended ", model, " to unique index ", j))
next
}
}
}
# group models by the same resolution
group_list <- data.frame(model=NA, polygon_index=NA)
# for each model
for (i in 1:length(raster_list) ) {
print(paste0("i ", i))
# extract model name and resolution raster
model <- names(raster_list)[i]
model_raster <- raster_list[[i]]
# compare model raster with each unique raster
for (j in 1:length(unique_rasters) ) {
print(paste0("j ", j))
# extract j-th unique resolution
unique_raster <- unique_rasters[[j]]
# when find the matching unique resolution, assign group index and continue to next model
if ( identical(model_raster, unique_raster) ) {
# assign group to model in group list
group_list <- rbind(
group_list,
data.frame(model=model, polygon_index=j, stringsAsFactors = FALSE)
)
#group_list[[model]] <- j
print(paste0("appended ", model, " to unique index ", j))
next
}
}
}
View(group_list)
# group models by the same resolution
group_list <- data.frame()
# for each model
for (i in 1:length(raster_list) ) {
print(paste0("i ", i))
# extract model name and resolution raster
model <- names(raster_list)[i]
model_raster <- raster_list[[i]]
# compare model raster with each unique raster
for (j in 1:length(unique_rasters) ) {
print(paste0("j ", j))
# extract j-th unique resolution
unique_raster <- unique_rasters[[j]]
# when find the matching unique resolution, assign group index and continue to next model
if ( identical(model_raster, unique_raster) ) {
# assign group to model in group list
group_list <- rbind(
group_list,
data.frame(model=model, polygon_index=j, stringsAsFactors = FALSE)
)
#group_list[[model]] <- j
print(paste0("appended ", model, " to unique index ", j))
next
}
}
}
View(group_list)
View(group_list_original)
# save group_list
write.csv(group_list, "../data/area_polygons/unique_polygons_list.rda", row.names = FALSE)
# save group_list
write.csv(group_list, "../data/area_polygons/unique_polygons_list.csv", row.names = FALSE)
write.table(group_list, "../data/area_polygons/unique_polygons_list.txt",
sep = "\t",        # use tab as separator; change to "," if you want CSV style
row.names = FALSE, # don't include row numbers
quote = FALSE)
# save group_list
write.table(group_list, "../data/area_polygons/unique_polygons_list.txt",
sep = ",",        # use tab as separator; change to "," if you want CSV style
row.names = FALSE, # don't include row numbers
quote = FALSE)
# make raster values of fraction (0.5 resolution) from proportion decade df
load("/Users/jiaruofei/MIT Dropbox/Ruofei Jia/Global_SOC/supercloud/data/proportion_decade_df.rda")
colnames(proportion_decade_df)
natural_fraction_df <- proportion_decade_df %>%
mutate(
value = sum(avg_youngforest1992_2020, avg_oldforest1992_2020, grassland1992_2020)
) %>%
dplyr::select(x,y,value)
max(natural_fraction_df$value)
natural_fraction_df <- proportion_decade_df %>%
mutate(
value = avg_youngforest1992_2020+avg_oldforest1992_2020+grassland1992_2020
) %>%
dplyr::select(x,y,value)
max(natural_fraction_df$value)
min(natural_fraction_df$value)
unique(natural_fraction_df$value)
ggplot(natural_fraction_df) +
geom_histogram(aes(x=value))
library(ggplot2)
ggplot(natural_fraction_df) +
geom_histogram(aes(x=value))
library(sp)
# make into spatial dataframe
# Step 1: convert to SpatialPixelsDataFrame
coordinates(natural_fraction_df) <- ~x+y        # set coordinates
gridded(natural_fraction_df) <- TRUE            # convert to grid
# Step 2: convert to raster
natural_fraction_raster <- raster(natural_fraction_df)
# optional: check
plot(natural_fraction_raster)
# optional: check
plot(natural_fraction_raster)
View(natural_fraction_df)
View(natural_fraction_raster)
par(mar=c(1,1,1,1))
# optional: check
plot(natural_fraction_raster)
